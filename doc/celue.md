# 二、 策略逻辑

## （一）选股逻辑
**选股**是根据配置的选股条件，筛选出每日标的池，其主要逻辑如下：
### 1、回测部分
#### （1）配置选股条件
	根据选股策略id，数据库配置对应选股条件。
#### （2）选股条件
	每个选股条件将对于全市场进行所配参数筛选，得到结果存入redis（{date:list(code}格式）、mysql中。
#### （3）选股结果
	根据选股id得到每个选股条件。选股时先从redis获取条件数据，若无则从mysql获取，若mysql无则调用选股条件函数从wind原库获取，每个条件取交集得到最终每日选股结果存入redis（{date:list(code)}格式）、mysql中。
### 2、实盘部分
	与回测逻辑相同，区别在于实盘会增加禁买池的筛选。选股结果会去掉禁买池的标的，并将当日禁买的标的落入当日黑名单。

## （二）资产配置
根据策略id得到资产配置方式，根据资产配置方式的不同，读取市盈率、流通市值、波动率、昨收盘等不同的指标数据，通过模型计算，为选股结果分配持仓，保证当天的持仓比例总和为1。

## （三）风控逻辑
**风控**是提供通过止损，最大回撤，集中度等来控制仓位或个股占比的功能，其主要逻辑如下：
### 1、回测部分
#### （1）止损
    根据策略当前净值来判断是否达到风控设定的止损阀值，达到就将仓位降到风控配置的仓位值
#### （2）最大回撤
    本策略n天内最大回撤或者n天内配置的基准标的（一般为指数）的最大回撤来控制仓位
#### （3）个股集中度
    通过配置个股最大占比来控制仓位
  当上述风控配置有多个时，最终仓位将会取每个风控类型的目标仓位中的最小值
### 2、实盘部分
    昨日总资产获取来源不同，其他逻辑与回测相同

## （四）生成订单
**生成订单**部分是根据目标仓位，当前总资产和当前持仓信息，计算出今日的调仓指令，和成交详情，目前支持类型（股票，ETF），主要逻辑如下：
### 1、回测部分
* （1）根据策略配置中的撮合价格类型获取预成交价（price），并按此预成交价重新计算totalAsset
* （2）结合各成分股目标仓位占比（targetratio）和总资产计算出目标占资（targetNotional）
* （3）用各股的目标占资（targetNotiional）- 持仓市值 ，计算出需调仓金额（resultNotional）、负值、需要卖出、正值、需要买入
* （4）根据标的及策略配置的交易系统获取计算出相应的手续费，然后从totalasset中减去手续费,并重新计算买的需调仓金额（resultNotional）
* （5）用 resultNotional/price 计算出基础调仓量。
* （6）对基础调仓量根据买卖不同方式做整百处理，基本处理方式：<br>
        **对于买**，以该标的类型的最小下单量(min_order_volume)为基准做向下取整<br>
        **对于卖**，以该标的类型的最小下单量(min_order_volume)为基准向上取整
### 2、实盘部分
与回测逻辑相同，不同之处在于**总资产（totalAsset）** 和 **持仓（preposition）** 是通过交易接口实时获取的最新状态。price从交易系统获取最新价
## （五）交易执行
**交易执行**主要指订单的执行情况。策略配置执行目标价参数，可以选择以开盘价、收盘价、均价等价格执行订单。回测及模拟部分以设置的目标价全部成交；实盘部分成交价和成交量通过算法交易的实际执行情况为准，根据不同的目标价参数选择相应的算法。
## （六）策略清算
**策略清算**指每一个交易日对策略进行交易、持仓、账户、资产、绩效等方面的清算过程。
其主要流程如下：
### 1、交易情况
**交易情况**包括交易标的所属策略、交易日期、交易标的、买卖方向、多空方向、实际占资、成交量、成交价、交易费用、名义本金及交易盈亏。成交情况参考上述（五）交易执行部分。其中,<br>
**实际占资** = 名义本金 * 保证金率<br>
**交易费用** = 成交量 * 成交价 * 费率<br>
**交易盈亏** = 多/空 * 买/卖 * 成交量 * （今日收盘价（期货是结算价） - 成交价）<br>
### 2、持仓情况
**持仓情况**包括交易标的所属策略、交易日期、多空方向、交易标的、账户类型、实际占资、持仓量、名义本金、标的前一交易日收盘价、标的今日收盘价及持仓盈亏。其中，<br>
**持仓盈亏** = 多/空 * 买/卖 * 持仓数量 * （今日收盘价（期货是结算价） - 昨日收盘价（期货是结算价））
### 3、账户情况
**账户情况**为分账户统计策略情况，账户类型包括期货账户和现货账户，具体包括交易标的所属策略、交易日期、账户类型、持仓市值、现金、日终总资产、日初总资产。有期货交易标的时，现金全部放在期货账户，具体如下：
#### （1）无期货持仓时，账户类型仅为现货类型：
**现金** = 策略今日盈亏 + 前一交易日日终总资产 – 今日持仓市值<br>
**日终总资产** =  策略今日盈亏 + 前一交易日日终总资产
#### （2）有期货持仓时，账户类型为期货和现货类型：
* 期货：<br>
**现金** = 策略今日盈亏 + 前一交易日日终总资产 – 今日持仓市值<br>
**日终总资产** =  现金 + 前一交易日期货日终总资产<br>
* 现货：<br>
**现金** = 0<br>
**日终总资产** =  现货持仓市值
### 4、资产情况
**资产情况**为策略合计情况，具体包括交易标的所属策略、交易日期、持仓市值、现金、日终总资产、日初总资产、策略总盈亏、策略净值。其中，<br>
**策略总盈亏** = 策略今日盈亏 + 前一交易日策略总盈亏<br>
**策略净值** = (日终总资产/日初总资产) * 前一交易日策略净值
### 5、绩效情况
**绩效指标**从多个角度对策略进行评价，绩效指标包括累计收益率、年化利率-复利、年平均收益率-非复利、夏普率、索提诺率、最大回撤率、最大回撤时长、5交易日最大回撤、20交易日最大回撤、日平均收益率-非复利、日平均波动率。绩效评价周期涵盖近一个月、近三个月、近半年、近一年、今年以来、成立以来。

